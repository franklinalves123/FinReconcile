# Story 1.9 — Gestão de Usuários Real (Supabase Auth)

**Epic:** MVP — Fase 3: Gestão e Administração
**Status:** Ready
**Estimativa:** 5 pontos (L)
**Agente responsável:** @dev (Dex)
**Bloqueado por:** Story 1.2 (credenciais externalizadas)

---

## Objetivo

Atualmente a gestão de usuários em Settings é uma simulação via `localStorage` — a lista de usuários não persiste no banco, não há convite real, e usuários adicionados não conseguem fazer login. Implementar gestão de usuários real usando Supabase Auth + tabela de perfis.

---

## Escopo

### IN
- Tela de usuários (master only) mostra usuários reais do Supabase
- Master pode convidar novo usuário por email (Supabase `admin.inviteUserByEmail` ou magic link)
- Master pode desativar/remover acesso de usuário
- Dados de usuário persistem no Supabase (tabela `profiles`)
- Remover toda a lógica de localStorage para users

### OUT
- Não implementar roles granulares (apenas master vs user)
- Não implementar SSO (Google, GitHub, etc.)
- Não implementar 2FA
- Family sharing (compartilhamento de dados entre usuários) — escopo V1

---

## Critérios de Aceite

- [ ] Tela de usuários lista apenas usuários do Supabase (não localStorage)
- [ ] Master pode convidar usuário por email (email de convite enviado)
- [ ] Usuário convidado acessa o app via link do email e define senha
- [ ] Master pode remover acesso de usuário (desativar ou excluir)
- [ ] Cada usuário vê apenas seus próprios dados (RLS verificado)
- [ ] MASTER_EMAIL é configurável via env var (não hardcoded em types.ts)
- [ ] Lista de usuários carrega do Supabase, não do localStorage

---

## Notas Técnicas

### Abordagem recomendada
Usar **Supabase Auth Admin API** para listar e convidar usuários. Isso requer a `service_role` key — que **NÃO deve ser exposta no client**.

**Alternativa mais segura para MVP:** Implementar via Supabase Edge Function (serverless) que recebe email e chama `admin.inviteUserByEmail` internamente. O client chama a Edge Function com o token de auth do usuário.

**Alternativa simples (MVP mínimo):** Usar apenas `signInWithOtp` (magic link) — usuário se cadastra sozinho; master vê a lista via tabela `profiles`.

### Tabela `profiles` (Supabase)
```sql
CREATE TABLE profiles (
  id UUID REFERENCES auth.users(id) PRIMARY KEY,
  email TEXT NOT NULL,
  role TEXT NOT NULL DEFAULT 'user', -- 'master' | 'user'
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- RLS
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users see own profile" ON profiles
  FOR SELECT USING (auth.uid() = id);
CREATE POLICY "Master sees all" ON profiles
  FOR SELECT USING (
    EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'master')
  );
```

### MASTER_EMAIL como env var
```typescript
// types.ts — remover MASTER_EMAIL hardcoded
// lib/supabase.ts ou utils.ts
export const MASTER_EMAIL = import.meta.env.VITE_MASTER_EMAIL;
```

Adicionar `VITE_MASTER_EMAIL` ao `.env.local.example`.

---

## Riscos

- **Alto:** Admin API do Supabase requer service_role key — não pode ficar no client. Avaliar Edge Function vs solução simplificada
- **Médio:** Migration de banco (tabela profiles + RLS) requer teste cuidadoso
- **Baixo:** Usuários existentes sem perfil na tabela `profiles` podem não aparecer

---

## Testes Sugeridos

1. Login com master email → aba "Gestão de Usuários" visível
2. Login com user email → aba "Gestão de Usuários" NÃO aparece
3. Master convida email → email de convite chega
4. Novo usuário clica no link → define senha → consegue logar
5. Usuário normal tenta acessar dados de outro usuário → RLS bloqueia (testar via Supabase Dashboard)
6. Master remove usuário → usuário não consegue mais logar

---

## File List

| Arquivo | Ação |
|---------|------|
| `types.ts` | Modificar (remover MASTER_EMAIL hardcoded) |
| `components/Settings.tsx` | Modificar (substituir localStorage por Supabase) |
| `services/dataService.ts` | Modificar (adicionar getUsers, inviteUser) |
| `lib/supabase.ts` | Modificar (adicionar VITE_MASTER_EMAIL) |
| `.env.local.example` | Modificar (adicionar VITE_MASTER_EMAIL) |

---

## Change Log

| Data | Agente | Ação |
|------|--------|------|
| 2026-02-20 | @architect (Brownfield) | Story criada |
