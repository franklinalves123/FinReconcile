# Story 1.12 — Testes Unitários com Vitest

**Epic:** MVP — Fase 4: Qualidade de Código
**Status:** Ready
**Estimativa:** 5 pontos (L)
**Agente responsável:** @dev (Dex)
**Bloqueado por:** Story 1.11 (build Vite estável)

---

## Objetivo

O projeto não possui nenhum teste automatizado. Implementar cobertura básica de testes unitários com Vitest (integrado ao Vite) cobrindo as funções críticas do domínio financeiro: serviços de dados, utilitários de ciclo, e a lógica de categorização.

---

## Escopo

### IN
- Instalar e configurar Vitest
- Testes para `lib/utils.ts` (getCycleInfo, exportToCSV)
- Testes para `services/dataService.ts` (mock do Supabase client)
- Testes para `services/geminiService.ts` (mock da API do Gemini)
- Testes para lógica de cálculo do Dashboard (cycleData, stats)
- Script `npm test` no package.json

### OUT
- Testes E2E (Playwright/Cypress) — escopo futuro
- Testes de componentes React (React Testing Library) — escopo futuro
- Cobertura 100% — meta é cobertura das funções críticas

---

## Critérios de Aceite

- [ ] `npm test` executa sem erros
- [ ] Cobertura dos módulos críticos: `lib/utils.ts` > 80%, `services/dataService.ts` > 60%
- [ ] Testes não fazem chamadas reais ao Supabase ou Gemini (mocks)
- [ ] Testes passam em CI/CD (se configurado futuramente)
- [ ] Mínimo 15 testes implementados cobrindo edge cases

---

## Notas Técnicas

### Instalação
```bash
npm install -D vitest @vitest/coverage-v8
```

### `vite.config.ts` — adicionar
```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
  },
  // ... resto da config
});
```

### Testes prioritários

**utils.ts**
```typescript
describe('getCycleInfo', () => {
  it('retorna ciclo baseado na data de importação da fatura')
  it('retorna ciclo baseado na purchaseDate para lançamentos manuais')
  it('retorna "Sem Ciclo" para transação sem datas')
  it('ordena corretamente por mês e ano')
})
```

**dataService.ts**
```typescript
// Mock do Supabase
vi.mock('../lib/supabase', () => ({ supabase: mockSupabaseClient }))

describe('dataService', () => {
  it('getTransactions mapeia snake_case para camelCase corretamente')
  it('saveTransactions converte manual-entry para null no invoice_id')
  it('deleteInvoice deleta transactions antes da fatura')
  it('getUserSettings retorna null sem erro em caso de 404')
})
```

**Domínio financeiro**
```typescript
describe('cycleData calculation', () => {
  it('agrupa transações por ciclo de importação')
  it('retorna apenas os últimos 6 ciclos')
  it('calcula tendência corretamente')
})
```

---

## Riscos

- **Baixo:** Configuração inicial do Vitest com React + TypeScript pode exigir ajustes no tsconfig
- **Baixo:** Mocks do Supabase precisam cobrir os patterns de chaining (`.from().select().eq()`)

---

## Testes Sugeridos (Meta-testes)

1. `npm test` → todos os testes passam
2. `npm test -- --coverage` → relatório de cobertura gerado em `coverage/`
3. Modificar `getCycleInfo` para retornar valor errado → teste falha
4. Rodar em modo watch: `npm test -- --watch`

---

## File List

| Arquivo | Ação |
|---------|------|
| `package.json` | Modificar (adicionar vitest, script test) |
| `vite.config.ts` | Modificar (adicionar config test) |
| `tests/utils.test.ts` | Criar |
| `tests/dataService.test.ts` | Criar |
| `tests/geminiService.test.ts` | Criar |
| `tests/domain.test.ts` | Criar |

---

## Change Log

| Data | Agente | Ação |
|------|--------|------|
| 2026-02-20 | @architect (Brownfield) | Story criada |
