# Story 1.10 — Insights AI (generateInsights)

**Epic:** MVP — Fase 3: Gestão e Administração
**Status:** Ready
**Estimativa:** 3 pontos (M)
**Agente responsável:** @dev (Dex)
**Bloqueado por:** Story 1.2 (credenciais), Story 1.3 (categorização real já funcionando)

---

## Objetivo

Implementar a função `generateInsights()` atualmente stub em `geminiService.ts`. Exibir insights automáticos no Dashboard, como: maiores gastos do ciclo, tendências, categorias que cresceram, possíveis economias.

---

## Escopo

### IN
- Implementar `generateInsights(transactions, categories)` com chamada real ao Gemini
- Exibir card de "Insights do Mês" no Dashboard (abaixo dos KPIs)
- No mínimo 3 insights por ciclo: maior categoria, comparativo vs ciclo anterior, destaque de gasto
- Texto em PT-BR, tom amigável e objetivo
- Cache de insights por ciclo (não chamar Gemini a cada render)

### OUT
- Insights preditivos / projeções
- Recomendações de investimento
- Comparação com médias do mercado (benchmark externo)

---

## Critérios de Aceite

- [ ] Card "Insights" visível no Dashboard após dados carregados
- [ ] Exibe pelo menos 3 bullets de análise em PT-BR
- [ ] Insights são gerados com base nas transações do ciclo atual
- [ ] Se Gemini falhar, card mostra mensagem amigável (não quebra o Dashboard)
- [ ] Insights não são recalculados a cada render (memoize/cache por cycleLabel)
- [ ] Tempo de carregamento do Dashboard não impacta visualmente (insights carregam em segundo plano)

---

## Notas Técnicas

### Assinatura alvo
```typescript
export const generateInsights = async (
  transactions: Transaction[],
  categories: Category[],
  previousCycleTransactions?: Transaction[]
): Promise<string[]> // Array de bullets de insight
```

### Prompt sugerido
```
Analise estes gastos de cartão de crédito de um brasileiro e gere 3-5 insights úteis em PT-BR:
- Total: R$ X em Y transações
- Maior categoria: {cat} com R$ Y (Z% do total)
- Comparativo: {X}% vs ciclo anterior
Lançamentos: [lista simplificada]

Responda com bullets simples e diretos, sem introdução. Max 1 linha por insight.
```

### Card no Dashboard
Posicionar após os 4 KPIs, antes do gráfico de evolução. Card colapsável para não poluir a interface.

### Caching
```typescript
// Em App.tsx ou Dashboard
const insightsCache = useRef<Record<string, string[]>>({});

// Gerar apenas se não estiver em cache
if (!insightsCache.current[currentCycleLabel]) {
  const insights = await generateInsights(cycleTransactions, categories);
  insightsCache.current[currentCycleLabel] = insights;
}
```

---

## Riscos

- **Médio:** Custo adicional por chamada Gemini — mitigar com cache
- **Baixo:** Insights genéricos se poucas transações (< 5) — ajustar prompt para esse caso

---

## Testes Sugeridos

1. Dashboard com > 10 transações → card de insights aparece com 3+ bullets
2. Dashboard com 0 transações → card não aparece ou exibe mensagem "Importe faturas para ver insights"
3. Navegar para outro ciclo e voltar → insights não recarregam do Gemini (cache hit)
4. Simular falha do Gemini → Dashboard não quebra, card mostra "Insights indisponíveis"

---

## File List

| Arquivo | Ação |
|---------|------|
| `services/geminiService.ts` | Modificar (implementar generateInsights) |
| `components/Dashboard.tsx` | Modificar (adicionar card de insights) |
| `App.tsx` | Modificar (passar dados para Dashboard + cache de insights) |
| `types.ts` | Modificar (se necessário para insights) |

---

## Change Log

| Data | Agente | Ação |
|------|--------|------|
| 2026-02-20 | @architect (Brownfield) | Story criada |
