# Story 1.7 — Detecção e Suporte a Parcelamentos

**Epic:** MVP — Fase 2: Qualidade e Dados
**Status:** Ready
**Estimativa:** 5 pontos (L)
**Agente responsável:** @dev (Dex)

---

## Objetivo

Faturas brasileiras frequentemente contêm parcelas no formato "LOJA X 02/06" (parcela 2 de 6). Atualmente o Gemini extrai cada parcela como uma transação independente, sem que o sistema saiba que pertencem a um parcelamento. Esta story implementa detecção básica de parcelamentos na extração e representação no domínio.

---

## Escopo

### IN
- Atualizar o prompt do Gemini em `extractInvoiceData` para identificar parcelas (formato `NN/NN`)
- Adicionar campos `installmentNumber` e `installmentTotal` ao tipo `ExtractedTransaction`
- Adicionar campos ao tipo `Transaction`: `installmentNumber?`, `installmentTotal?`
- Exibir badge de parcelamento na tela de Review (ex: "2/6")
- Exibir badge de parcelamento na tabela de Reports

### OUT
- Não rastrear o valor total do parcelamento (soma das parcelas)
- Não projetar parcelas futuras (escopo V1)
- Não agrupar parcelas no Dashboard (cada parcela é um lançamento independente no MVP)

---

## Critérios de Aceite

- [ ] Gemini retorna `installmentNumber` e `installmentTotal` quando detectado no texto (ex: "02/06")
- [ ] Se não há parcelamento, campos ficam como `null`/`undefined`
- [ ] Tela de Review exibe badge "2/6" ao lado da descrição quando parcelamento detectado
- [ ] Tabela de Reports exibe coluna ou badge de parcelamento
- [ ] Campos são salvos no Supabase (adicionar colunas `installment_number`, `installment_total` à tabela `transactions`)
- [ ] `dataService.ts` mapeia os novos campos no SELECT e INSERT

---

## Notas Técnicas

### Atualização do schema Gemini (`extractInvoiceData`)
```typescript
export interface ExtractedTransaction {
  purchaseDate: string;
  description: string;
  amount: number;
  installmentNumber?: number;   // ex: 2
  installmentTotal?: number;    // ex: 6
}
```

### Atualização do responseSchema
Adicionar ao schema do Gemini:
```
installmentNumber: { type: Type.NUMBER, nullable: true }
installmentTotal: { type: Type.NUMBER, nullable: true }
```

### SQL migration (Supabase)
```sql
ALTER TABLE transactions
  ADD COLUMN IF NOT EXISTS installment_number INTEGER,
  ADD COLUMN IF NOT EXISTS installment_total INTEGER;
```

### Badge no Review.tsx
```tsx
{t.installmentNumber && t.installmentTotal && (
  <span className="text-[9px] bg-yellow-50 text-yellow-700 border border-yellow-200 px-1 py-0.5 rounded font-bold">
    {t.installmentNumber}/{t.installmentTotal}
  </span>
)}
```

---

## Riscos

- **Médio:** Diferentes bancos usam formatos distintos de parcelamento — o prompt pode não capturar todos
- **Médio:** Requer migration de banco (adicionar colunas) — documentar e testar
- **Baixo:** Gemini pode confundir "PARCELA" com outros padrões numéricos

---

## Testes Sugeridos

1. Importar fatura do Inter/Bradesco com compra parcelada → verificar campos `installmentNumber/Total`
2. Importar fatura sem parcelamentos → campos devem ser `null`
3. Badge "2/6" aparece corretamente na Review e Reports
4. Verificar no Supabase que as colunas estão sendo salvas
5. Editar uma transação parcelada no modal → parcelamento mantido

---

## File List

| Arquivo | Ação |
|---------|------|
| `types.ts` | Modificar (adicionar installmentNumber, installmentTotal à Transaction e ExtractedTransaction) |
| `services/geminiService.ts` | Modificar (prompt + schema para parcelamentos) |
| `services/dataService.ts` | Modificar (SELECT e INSERT dos novos campos) |
| `components/Review.tsx` | Modificar (badge de parcelamento) |
| `components/Reports.tsx` | Modificar (exibir parcelamento na tabela) |
| `docs/architecture/current-state.md` | Atualizar (schema da Transaction) |

---

## Change Log

| Data | Agente | Ação |
|------|--------|------|
| 2026-02-20 | @architect (Brownfield) | Story criada |
