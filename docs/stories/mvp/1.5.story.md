# Story 1.5 — Error Handling, UX e Eliminação de window.prompt/confirm

**Epic:** MVP — Fase 1: Core Funcional
**Status:** Ready
**Estimativa:** 3 pontos (M)
**Agente responsável:** @dev (Dex)

---

## Objetivo

Melhorar a robustez e a UX do app eliminando o uso de `window.prompt()` e `window.confirm()`, adicionando error boundaries para prevenir crashes silenciosos, e melhorando as mensagens de erro em pontos críticos do fluxo.

---

## Escopo

### IN
- Adicionar `ErrorBoundary` global (React class component ou biblioteca) envolvendo o `<AppContent>`
- Substituir todos os `window.prompt()` por modais React (criação de categoria/subcategoria na Review)
- Substituir todos os `window.confirm()` por `ConfirmModal` (Story 1.4 já cria o componente)
- Substituir todos os `alert()` por toast/snackbar não-bloqueante
- Melhorar tratamento de erro na extração Gemini: tela de erro com botão "Tentar novamente" e "Lançar manualmente"
- Validar tamanho do arquivo antes do upload (> 15MB → rejeitar com mensagem)

### OUT
- Não implementar logging remoto de erros (Sentry, etc.) — escopo futuro
- Não implementar retry automático de requisições Gemini

---

## Critérios de Aceite

- [ ] `window.prompt()` não é chamado em nenhum lugar do codebase
- [ ] `window.confirm()` não é chamado em nenhum lugar do codebase
- [ ] `alert()` não é chamado em nenhum lugar do codebase
- [ ] Criação de categoria/subcategoria usa modal React com input field
- [ ] Se Gemini falhar na extração, usuário vê tela de erro com 2 opções: "Tentar novamente" e "Cancelar"
- [ ] Arquivo > 15MB é rejeitado no Upload com mensagem clara (não enviado ao Gemini)
- [ ] `ErrorBoundary` captura erros não tratados e exibe tela amigável em vez de tela branca
- [ ] Mensagens de sucesso/erro usam toast não-bloqueante (auto-dismiss em 3s)

---

## Notas Técnicas

### Ocorrências de window.prompt()
- `components/Review.tsx:62` — `handleCreateCategory`
- `components/Review.tsx:78` — `handleCreateSubcategory`

### Ocorrências de window.confirm()
- `App.tsx:162` — `handleDeleteInvoice`

### Ocorrências de alert()
- `App.tsx:90, 103, 153, 169, 204, 262, 265` (múltiplos)
- `components/Settings.tsx:66, 73`

### Componente Toast sugerido
Criar `components/ui/Toast.tsx` simples com context ou usar estado em App.tsx passado como prop.

```typescript
// Exemplo de hook
const { showToast } = useToast();
showToast('Fatura salva com sucesso!', 'success');
showToast('Erro ao salvar. Tente novamente.', 'error');
```

### Componente InputModal (substitui window.prompt)
```typescript
// components/ui/InputModal.tsx
interface InputModalProps {
  isOpen: boolean;
  title: string;
  placeholder: string;
  onConfirm: (value: string) => void;
  onCancel: () => void;
}
```

### ErrorBoundary
```typescript
// components/ErrorBoundary.tsx
class ErrorBoundary extends React.Component<...> {
  static getDerivedStateFromError(error) { return { hasError: true }; }
  render() {
    if (this.state.hasError) {
      return <ErrorScreen onRetry={() => window.location.reload()} />;
    }
    return this.props.children;
  }
}
```

---

## Riscos

- **Baixo:** Muitas ocorrências de `alert()` — refatoração sistemática necessária mas não complexa
- **Baixo:** Toast pode precisar de z-index ajustado para não sobrepor modais

---

## Testes Sugeridos

1. Criar nova categoria na tela de Review → modal aparece, não window.prompt
2. Excluir fatura → ConfirmModal aparece, não window.confirm
3. Simular erro de rede no Supabase → toast de erro aparece e desaparece em 3s
4. Fazer upload de PDF > 15MB → mensagem de rejeição imediata
5. Forçar erro em componente (throw) → ErrorBoundary exibe tela amigável

---

## File List

| Arquivo | Ação |
|---------|------|
| `components/ErrorBoundary.tsx` | Criar |
| `components/ui/Toast.tsx` | Criar |
| `components/ui/InputModal.tsx` | Criar |
| `components/ui/ConfirmModal.tsx` | Criar (ou já criado na Story 1.4) |
| `components/Review.tsx` | Modificar (substituir window.prompt) |
| `components/Upload.tsx` | Modificar (validação de tamanho) |
| `components/Settings.tsx` | Modificar (substituir alert) |
| `App.tsx` | Modificar (substituir alert/confirm, adicionar ErrorBoundary) |
| `index.tsx` | Modificar (envolver App com ErrorBoundary) |

---

## Change Log

| Data | Agente | Ação |
|------|--------|------|
| 2026-02-20 | @architect (Brownfield) | Story criada |
