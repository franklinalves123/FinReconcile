# Story 1.3 — Categorização Automática via AI (Real)

**Epic:** MVP — Fase 1: Core Funcional
**Status:** Ready
**Estimativa:** 3 pontos (M)
**Agente responsável:** @dev (Dex)
**Bloqueado por:** Story 1.2 (precisa de env vars para API key)

---

## Objetivo

Implementar a função `categorizeTransactions()` em `services/geminiService.ts`, que atualmente é um stub retornando `'Outros'` para todas as transações. O objetivo é usar o Gemini para classificar inteligentemente as descrições das transações nas categorias do usuário.

---

## Escopo

### IN
- Implementar `categorizeTransactions(descriptions, categories)` com chamada real ao Gemini
- Passar as categorias do usuário como contexto no prompt
- Retornar mapa `{ [description]: categoryName }` com fallback para `'Outros'`
- Exibir badge de confiança (AI / Manual) na tela de Review
- Verificar e corrigir o nome do modelo Gemini (`gemini-3-flash-preview` → validar atual)

### OUT
- Não implementar aprendizado contínuo (feedback loop)
- Não implementar subcategorização automática (apenas categoria principal)

---

## Critérios de Aceite

- [ ] Após importação de fatura, transações com descrições reconhecíveis (ex: "UBER", "IFOOD", "AMAZON") recebem categoria correta em > 70% dos casos
- [ ] Transações que o Gemini não consegue categorizar ficam como `'Outros'` (sem crash)
- [ ] A função recebe a lista de categorias do usuário como contexto
- [ ] Tela de Review mostra badge `[AI]` nas transações categorizadas automaticamente
- [ ] Timeout de 30s na requisição de categorização; se atingido, todas ficam como `'Outros'` com aviso
- [ ] Modelo Gemini correto está sendo usado (verificar nome atual na documentação)

---

## Notas Técnicas

### Assinatura atual (stub)
```typescript
export const categorizeTransactions = async (descriptions: string[]) => {
  const map: Record<string, string> = {};
  descriptions.forEach(d => map[d] = 'Outros');
  return map;
};
```

### Assinatura alvo
```typescript
export const categorizeTransactions = async (
  descriptions: string[],
  categories: Category[]
): Promise<Record<string, { category: string; confidence: 'high' | 'medium' | 'low' }>>
```

### Prompt sugerido
```
Categorize as seguintes descrições de transações de cartão de crédito brasileiro.
Categorias disponíveis: ${categories.map(c => c.name).join(', ')}.
Retorne um JSON com cada descrição mapeada para a categoria mais apropriada.
Se não souber, use "Outros".
Descrições: ${JSON.stringify(descriptions)}
```

### Impacto no App.tsx
A chamada em `handleUploadComplete()` precisa ser atualizada para passar as `categories` do estado:
```typescript
// Antes
const aiCategories = await categorizeTransactions(extractedData.map(d => d.description));

// Depois
const aiCategories = await categorizeTransactions(
  extractedData.map(d => d.description),
  categories
);
```

### Badge de confiança no Review.tsx
Adicionar campo `aiCategorized?: boolean` à `Transaction` ou usar o campo `confidence` existente. Exibir badge `[AI]` ao lado da categoria na tabela de revisão.

---

## Riscos

- **Médio:** Custo por requisição Gemini — batch de descrições em uma única chamada para minimizar
- **Baixo:** Latência adicional (pode fazer em paralelo com a extração ou logo após)
- **Baixo:** Usuário pode ter categorias em português que o Gemini não reconhece — usar exemplos no prompt

---

## Testes Sugeridos

1. Importar fatura do Inter com transações de Uber, iFood, farmácia → verificar categorias
2. Importar fatura com transações desconhecidas → confirmar que ficam como "Outros"
3. Usuário com categoria customizada "Pets" → verificar se Gemini consegue categorizar "COBASI"
4. Simular timeout do Gemini → app não pode travar; deve prosseguir com "Outros"
5. Fatura com 80+ transações → verificar que batch completo é processado

---

## File List

| Arquivo | Ação |
|---------|------|
| `services/geminiService.ts` | Modificar (implementar categorizeTransactions real) |
| `App.tsx` | Modificar (passar categories para categorizeTransactions) |
| `types.ts` | Modificar (adicionar confidence ao Transaction ou campo aiCategorized) |
| `components/Review.tsx` | Modificar (exibir badge AI) |

---

## Change Log

| Data | Agente | Ação |
|------|--------|------|
| 2026-02-20 | @architect (Brownfield) | Story criada |
