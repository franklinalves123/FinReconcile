# Story 1.2 — Externalizar Credenciais (Segurança)

**Epic:** MVP — Fase 0: Fundação
**Status:** Ready
**Estimativa:** 2 pontos (S)
**Agente responsável:** @dev (Dex)
**Bloqueante de:** Stories 1.3 em diante (não pode ir para produção com keys hardcoded)

---

## Objetivo

Remover todas as chaves de API e credenciais hardcoded do código-fonte e HTML, migrando para variáveis de ambiente do Vite (`import.meta.env`). Atualmente a `GEMINI_API_KEY` está exposta no `index.html` e as credenciais do Supabase estão em `lib/supabase.ts`.

---

## Escopo

### IN
- Migrar `GEMINI_API_KEY` de `index.html` para `import.meta.env.VITE_GEMINI_API_KEY`
- Migrar `SUPABASE_URL` de `lib/supabase.ts` para `import.meta.env.VITE_SUPABASE_URL`
- Migrar `SUPABASE_ANON_KEY` de `lib/supabase.ts` para `import.meta.env.VITE_SUPABASE_ANON_KEY`
- Criar arquivo `.env.local.example` com template (sem valores reais)
- Garantir que `.env.local` está no `.gitignore` (ver Story 1.1)
- Atualizar README com instruções de configuração

### OUT
- Não alterar lógica de auth ou Gemini
- Não migrar para sistema de secrets (vault, etc.) — escopo futuro

---

## Critérios de Aceite

- [ ] `index.html` não contém nenhuma string de API key ou token
- [ ] `lib/supabase.ts` não contém URLs ou keys hardcoded
- [ ] `services/geminiService.ts` lê a key via `import.meta.env.VITE_GEMINI_API_KEY`
- [ ] Arquivo `.env.local.example` existe na raiz com todas as variáveis documentadas (sem valores)
- [ ] `npm run dev` funciona corretamente com `.env.local` configurado
- [ ] `npm run build` funciona; bundle não contém as keys (verificar com `grep` no dist/)
- [ ] README atualizado com seção "Configuração de Ambiente"

---

## Notas Técnicas

### Mudanças em `index.html`
Remover o bloco `window.process = { env: { API_KEY: '...' } }` do `<script>`.

O `vite.config.ts` já define `'global': 'window'` — verificar se alguma biblioteca ainda precisa de `window.process` e, se sim, injetar apenas `NODE_ENV` (sem a key real).

### Mudanças em `lib/supabase.ts`
```typescript
// Antes
const SUPABASE_URL = 'https://neyio...supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbG...';

// Depois
const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;
```

### Mudanças em `services/geminiService.ts`
```typescript
// Antes
const getSafeApiKey = () => (window as any).process?.env?.API_KEY || '';

// Depois
const apiKey = import.meta.env.VITE_GEMINI_API_KEY || '';
```

### Arquivo `.env.local.example`
```
VITE_SUPABASE_URL=https://seu-projeto.supabase.co
VITE_SUPABASE_ANON_KEY=sua-anon-key-aqui
VITE_GEMINI_API_KEY=sua-gemini-api-key-aqui
```

### Importmap no `index.html`
O importmap usa `esm.sh` para dev sem bundle — isso é válido para desenvolvimento local mas em produção o Vite faz bundle. Verificar se o importmap pode ser removido após a migração para build correto com Tailwind (Story 1.11).

---

## Riscos

- **Médio:** Hospedagem cPanel pode não suportar variáveis de ambiente de build — documentar que as envs devem ser configuradas no momento do `npm run build` local, e o `dist/` é enviado ao servidor
- **Baixo:** TypeScript pode reclamar de `import.meta.env` sem tipagem — adicionar `vite/client` ao `tsconfig.json`

---

## Testes Sugeridos

1. Remover `.env.local` e confirmar que o app mostra erro claro "Credenciais não configuradas"
2. Configurar `.env.local` e confirmar login no Supabase funciona
3. Confirmar que extração Gemini funciona com a key via env var
4. `grep -r "AIzaSy" dist/` após build → deve retornar vazio
5. `grep -r "eyJhbG" dist/` após build → deve retornar vazio (anon key não deve estar no bundle como literal)

---

## File List

| Arquivo | Ação |
|---------|------|
| `index.html` | Modificar (remover API_KEY hardcoded) |
| `lib/supabase.ts` | Modificar (usar import.meta.env) |
| `services/geminiService.ts` | Modificar (usar import.meta.env) |
| `.env.local.example` | Criar |
| `tsconfig.json` | Modificar (adicionar vite/client) |
| `README.md` | Modificar (seção de configuração) |

---

## Change Log

| Data | Agente | Ação |
|------|--------|------|
| 2026-02-20 | @architect (Brownfield) | Story criada |
