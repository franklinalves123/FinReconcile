# Story 1.8 — Export Real de Dados (CSV)

**Epic:** MVP — Fase 2: Qualidade e Dados
**Status:** Ready
**Estimativa:** 2 pontos (S)
**Agente responsável:** @dev (Dex)

---

## Objetivo

A funcionalidade atual de "Exportar PDF" em Reports usa `window.print()`, que exporta a tela renderizada como PDF do navegador — frágil e com layout inconsistente. Esta story implementa export real de CSV que pode ser aberto em Excel ou Google Sheets.

---

## Escopo

### IN
- Botão "Exportar CSV" na tela de Reports (substituindo ou complementando o botão existente)
- Export aplica os mesmos filtros ativos (ciclo, tag, busca)
- Arquivo CSV gerado client-side (sem back-end), com encoding UTF-8 BOM para compatibilidade com Excel
- Colunas: Data, Descrição, Banco, Categoria, Subcategoria, Tags, Valor

### OUT
- Export Excel nativo (XLSX) — escopo futuro
- Export PDF real (biblioteca PDF) — escopo futuro
- Manter `window.print()` como opção secundária ou remover

---

## Critérios de Aceite

- [ ] Botão "Exportar CSV" visível na tela de Reports no modo tabela
- [ ] Clique gera e faz download de arquivo `.csv`
- [ ] Nome do arquivo inclui período do filtro: `finreconcile-Jan-25.csv` ou `finreconcile-todos.csv`
- [ ] Arquivo abre corretamente no Excel (Windows) com caracteres especiais (ã, ç, é)
- [ ] Arquivo abre corretamente no Google Sheets
- [ ] Export respeita filtros ativos (não exporta todos os dados)
- [ ] Valores monetários usam vírgula como separador decimal (padrão PT-BR para CSV)

---

## Notas Técnicas

### Geração de CSV client-side
```typescript
const exportToCSV = (data: Transaction[], filename: string) => {
  const BOM = '\uFEFF'; // BOM para UTF-8 com suporte a caracteres especiais no Excel
  const headers = ['Data', 'Descrição', 'Banco', 'Categoria', 'Subcategoria', 'Tags', 'Valor'];
  const rows = data.map(t => [
    t.purchaseDate,
    `"${t.description.replace(/"/g, '""')}"`, // escape aspas
    t.cardIssuer || '',
    t.category,
    t.subcategory || '',
    (t.tags || []).join(' | '),
    t.amount.toFixed(2).replace('.', ',') // BR format
  ]);

  const csv = BOM + [headers, ...rows].map(r => r.join(';')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
};
```

**Nota:** Usar `;` como separador (padrão PT-BR no Excel) em vez de `,`.

---

## Riscos

- **Baixo:** Browsers modernos suportam `URL.createObjectURL` — sem dependência externa necessária

---

## Testes Sugeridos

1. Exportar com filtro "Ciclo: Jan/25" → arquivo CSV com transações apenas de Jan/25
2. Exportar com busca "uber" → apenas transações com "uber" na descrição
3. Abrir arquivo no Excel → colunas corretas, sem caracteres estranhos
4. Abrir no Google Sheets → mesmos dados
5. Descrição com vírgula/ponto-e-vírgula → não quebra o CSV

---

## File List

| Arquivo | Ação |
|---------|------|
| `components/Reports.tsx` | Modificar (adicionar botão e função exportToCSV) |
| `lib/utils.ts` | Modificar (adicionar função exportToCSV reutilizável) |

---

## Change Log

| Data | Agente | Ação |
|------|--------|------|
| 2026-02-20 | @architect (Brownfield) | Story criada |
